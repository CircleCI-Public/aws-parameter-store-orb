description: >
  Fetch and load in your parameter store values as environment variables.
steps:
  - aws-cli/install
  - aws-cli/configure
  - run:
      name: Load AWS Parameters into environment
      command: |
        echo "#!/bin/bash" >> /tmp/parameterstore
        for row in $(aws ssm describe-parameters --no-paginate | jq -c '.Parameters[]'); do
          _jq() {
            PARNAME=$(jq -r '.Name' \<<< ${row})
            PARTYPE=$(jq -r '.Type' \<<< ${row})
            # convert all data to strings
            if [ $PARTYPE == "SecureString" ]
            then
              echo "Decode the string"
            elif [ $PARTYPE == "StringList" ]
            then
              echo "Covert list to string"
            else # Assume string
              PARDATA=$(aws ssm get-parameters --names ${PARNAME} | jq -r '.Parameters[].Value')
            fi
            echo "export ${PARNAME}=${PARDATA}" >> /tmp/parameterstore
          }
          echo $(_jq)
          source /tmp/parameterstore
        done
