description: >
  Fetch and load in your parameter store values as environment variables.
steps:
  - aws-cli/install
  - aws-cli/configure
  - run:
      name: Load AWS Parameters into environment
      command: |
        mkdir -p /tmp/parameterstore/
        for row in $(aws ssm describe-parameters --no-paginate | jq -c '.Parameters[]'); do
          _jq() {
            PARNAME=$(jq -r '.Name' \<<< ${row})
            PARTYPE=$(jq -r '.Type' \<<< ${row})
            # convert all data to strings
            if [ $PARTYPE == "SecureString" ] # Decode encrypted string
            then
              echo "Decode the string"
            else # Assume string
              PARDATA=$(aws ssm get-parameters --names ${PARNAME} | jq '.Parameters[].Value')
            fi
            if [ -z $PARDATA ]
            then
              echo "${PARNAME} appears to be empty. Please double check the value of this parameter."
              exit 1
            fi
            if [ -f /tmp/parameterstore/${PARNAME} ]
            then
              echo "This value has already been stored. Is this value stored twice?"
              exit 1
            fi
            echo ${PARDATA} >> /tmp/parameterstore/${PARNAME}
            echo "export ${PARNAME}=`cat /tmp/parameterstore/${PARNAME}`" >> /tmp/parameterstore/PARAMETERSTORESOURCEFILE
          }
          echo $(_jq)
          source /tmp/parameterstore/PARAMETERSTORESOURCEFILE
        done
