description: >
  Fetch and load in your parameter store values as environment variables.
steps:
  - aws-cli/install
  - aws-cli/configure
  - run:
      name: Load AWS Parameters into environment
      command: |
        mkdir -p /tmp/parameterstore/
        echo "debug 0 BEGIN"
        for row in $(aws ssm describe-parameters --no-paginate | jq -c '.Parameters[]'); do
          _jq() {
            echo "debug 1 BEGIN ROW"
            PARNAME=$(jq -r '.Name' \<<< "${row}")
            PARTYPE=$(jq -r '.Type' \<<< "${row}")
            echo "debug 2 ENV SET"
            # convert all data to strings
            if [ "$PARTYPE" == "SecureString" ] # Decode encrypted string
            then
              echo "Decode the string"
            else # Assume string
              PARDATA=$(aws ssm get-parameters --names "${PARNAME}" | jq '.Parameters[].Value')
            fi
            if [ -z "$PARDATA" ]
            then
              echo "${PARNAME} appears to be empty. Please double check the value of this parameter."
              exit 1
            fi
            if [ -f /tmp/parameterstore/"${PARNAME}" ]
            then
              echo "This value has already been stored. Is this value stored twice?"
              exit 1
            fi
            echo "debug 4"
            echo "${PARDATA}" >> /tmp/parameterstore/"${PARNAME}"
            echo "debug 5 FILE WRITTEN"
            echo "export ${PARNAME}=$(cat /tmp/parameterstore/"${PARNAME}")" >> /tmp/parameterstore/PARAMETERSTORESOURCEFILE
            echo "debug 6 ADDED TO SOURCE FILE"
          }
          _jq
        done
        echo "debug 7 SOURCING FILE"
        source /tmp/parameterstore/PARAMETERSTORESOURCEFILE
